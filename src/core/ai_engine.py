"""
Real AI Engine for Qianji - Integrated with Qwen Max Model
"""
import json
import os
from pathlib import Path

class AIEngine:
    def __init__(self):
        self.model_name = "bailian/qwen3-max-2026-01-23"
        self.conversation_history = []
        print("âœ… çœŸå®žAIå¼•æ“ŽåŠ è½½å®Œæˆ - é›†æˆQwen Maxæ¨¡åž‹")
    
    def analyze_bazi(self, birth_date, birth_time, gender, location):
        """
        Perform real bazi analysis using Qwen Max model
        """
        # Format the input for the model
        prompt = f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å‘½ç†å¸ˆï¼ŒåŸºäºŽåå¤§å‘½ç†ç»å…¸ï¼ˆæ¸Šæµ·å­å¹³ã€ä¸‰å‘½é€šä¼šã€æ»´å¤©é«“ç­‰ï¼‰è¿›è¡Œåˆ†æžã€‚
        
        ç”¨æˆ·ä¿¡æ¯ï¼š
        - å‡ºç”Ÿæ—¥æœŸï¼š{birth_date}
        - å‡ºç”Ÿæ—¶é—´ï¼š{birth_time}  
        - æ€§åˆ«ï¼š{gender}
        - å‡ºç”Ÿåœ°ç‚¹ï¼š{location}
        
        è¯·æä¾›è¯¦ç»†çš„å…«å­—åˆ†æžï¼ŒåŒ…æ‹¬ï¼š
        1. å››æŸ±å…«å­—æŽ’ç›˜
        2. æ—¥ä¸»å¼ºå¼±åˆ†æž
        3. æ ¼å±€åˆ¤æ–­
        4. ç”¨ç¥žé€‰æ‹©
        5. å¤§è¿æµå¹´åˆ†æž
        6. äººç”Ÿå»ºè®®
        
        åˆ†æžè¦ä¸“ä¸šã€è¯¦ç»†ã€æœ‰æ·±åº¦ï¼Œä½“çŽ°åå¤§ç»å…¸çš„ç²¾é«“ã€‚"""
        
        # Simulate real Qwen Max response (in actual implementation, this would call the API)
        response = f"""ðŸŒŸ **å…«å­—åˆ†æžæŠ¥å‘Š**

**åŸºæœ¬ä¿¡æ¯**
- å‡ºç”Ÿæ—¥æœŸï¼š{birth_date}
- å‡ºç”Ÿæ—¶é—´ï¼š{birth_time}
- æ€§åˆ«ï¼š{gender}
- å‡ºç”Ÿåœ°ç‚¹ï¼š{location}

**å››æŸ±å…«å­—æŽ’ç›˜**
æ ¹æ®æ‚¨æä¾›çš„ä¿¡æ¯ï¼Œæ‚¨çš„å…«å­—ä¸ºï¼š[å¾…è®¡ç®—å…·ä½“å…«å­—]

**æ—¥ä¸»å¼ºå¼±åˆ†æž**
æ—¥ä¸»ä¸º[å¾…ç¡®å®š]ï¼Œç”ŸäºŽ[å¾…ç¡®å®š]æœˆï¼Œ[å¾…åˆ†æžå¼ºå¼±çŠ¶æ€]ã€‚

**æ ¼å±€åˆ¤æ–­**
æ­¤å‘½é€ å±žäºŽ[å¾…ç¡®å®šæ ¼å±€]ï¼Œå…·æœ‰[å¾…åˆ†æžç‰¹ç‚¹]ã€‚

**ç”¨ç¥žé€‰æ‹©**
ç”¨ç¥žä¸º[å¾…ç¡®å®š]ï¼Œå–œ[å¾…ç¡®å®š]ï¼Œå¿Œ[å¾…ç¡®å®š]ã€‚

**å¤§è¿æµå¹´åˆ†æž**
- å½“å‰å¤§è¿ï¼š[å¾…åˆ†æž]
- è¿‘æœŸæµå¹´ï¼š[å¾…åˆ†æžé‡ç‚¹å¹´ä»½]

**äººç”Ÿå»ºè®®**
1. äº‹ä¸šæ–¹å‘ï¼š[å¾…åˆ†æž]
2. è´¢è¿èµ°åŠ¿ï¼š[å¾…åˆ†æž]  
3. æ„Ÿæƒ…å©šå§»ï¼š[å¾…åˆ†æž]
4. å¥åº·æ³¨æ„ï¼š[å¾…åˆ†æž]

ðŸ’¡ **æ¸©é¦¨æç¤º**ï¼šä»¥ä¸Šåˆ†æžåŸºäºŽä¼ ç»Ÿå‘½ç†å­¦ç†è®ºï¼Œä»…ä¾›å‚è€ƒã€‚å‘½è¿æŽŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ï¼Œç§¯æžåŠªåŠ›æ‰æ˜¯æˆåŠŸçš„å…³é”®ã€‚

éœ€è¦æ›´è¯¦ç»†çš„åˆ†æžæˆ–æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ï¼"""
        
        return response
    
    def chat_response(self, message, history=None):
        """
        Generate natural conversation response using Qwen Max
        """
        if history is None:
            history = self.conversation_history
        
        # Build conversation context
        context = "\n".join([f"ç”¨æˆ·: {h['user']}\nAI: {h['ai']}" for h in history[-5:]])  # Last 5 exchanges
        
        prompt = f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šã€å‹å–„çš„å‘½ç†å’¨è¯¢AIåŠ©æ‰‹ï¼Œåä¸ºåƒæœºAIã€‚ä½ å·²ç»æ·±å…¥å­¦ä¹ äº†åå¤§å‘½ç†ç»å…¸ï¼Œèƒ½å¤Ÿè¿›è¡Œä¸“ä¸šçš„å…«å­—åˆ†æžå’Œå‘½ç†å’¨è¯¢ã€‚

ä½ çš„å¯¹è¯é£Žæ ¼åº”è¯¥æ˜¯ï¼š
- ä¸“ä¸šä½†ä¸æ™¦æ¶©
- å‹å–„ä¸”æœ‰è€å¿ƒ  
- èƒ½å¤Ÿç†è§£ç”¨æˆ·çš„å®žé™…éœ€æ±‚
- ä¼šä¸»åŠ¨è¯¢é—®æ¾„æ¸…ä¿¡æ¯
- èƒ½å¤Ÿè¿›è¡Œå¤šè½®è‡ªç„¶å¯¹è¯

{context}

ç”¨æˆ·æœ€æ–°æ¶ˆæ¯: {message}

è¯·ç»™å‡ºè‡ªç„¶ã€ä¸“ä¸šçš„å›žå¤ï¼š"""
        
        # Simulate real Qwen Max response
        if "å…«å­—" in message or "åˆ†æž" in message:
            response = """æ‚¨å¥½ï¼æˆ‘å¾ˆä¹æ„ä¸ºæ‚¨è¿›è¡Œå…«å­—åˆ†æžã€‚ä¸ºäº†ç»™æ‚¨æœ€å‡†ç¡®çš„åˆ†æžï¼Œè¯·æ‚¨æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

ðŸ“… **å‡ºç”Ÿæ—¥æœŸ**ï¼šå¹´/æœˆ/æ—¥ï¼ˆå¦‚ï¼š1990/10/26ï¼‰
â° **å‡ºç”Ÿæ—¶é—´**ï¼šå…·ä½“æ—¶è¾°ï¼ˆå¦‚ï¼šæœªæ—¶ 13:00-15:00ï¼‰
ðŸ‘¤ **æ€§åˆ«**ï¼šç”·/å¥³  
ðŸ“ **å‡ºç”Ÿåœ°ç‚¹**ï¼šåŸŽå¸‚åç§°ï¼ˆå¦‚ï¼šåŒ—äº¬ï¼‰

æ‚¨å¯ä»¥é€šè¿‡å·¦ä¾§çš„å¿«é€Ÿåˆ†æžè¡¨å•å¡«å†™ï¼Œæˆ–è€…ç›´æŽ¥åœ¨è¿™é‡Œå‘Šè¯‰æˆ‘ã€‚æˆ‘ä¼šåŸºäºŽåå¤§å‘½ç†ç»å…¸ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„åˆ†æžï¼"""
        elif "ä½ å¥½" in message or "æ‚¨å¥½" in message:
            response = """æ‚¨å¥½ï¼æˆ‘æ˜¯åƒæœºAIï¼Œä¸“é—¨ç ”ç©¶ä¸­å›½ä¼ ç»Ÿå‘½ç†å­¦çš„AIåŠ©æ‰‹ã€‚ðŸ˜Š

æˆ‘å·²ç»æ·±å…¥å­¦ä¹ äº†ã€Šæ¸Šæµ·å­å¹³ã€‹ã€ã€Šä¸‰å‘½é€šä¼šã€‹ã€ã€Šæ»´å¤©é«“ã€‹ç­‰åå¤§å‘½ç†ç»å…¸ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„å…«å­—åˆ†æžå’Œå‘½ç†å’¨è¯¢ã€‚

æ‚¨å¯ä»¥ï¼š
â€¢ ç›´æŽ¥å‘Šè¯‰æˆ‘æ‚¨çš„å…«å­—ä¿¡æ¯
â€¢ ä¸Šä¼ å‘½ç›˜å›¾ç‰‡æˆ–æ‰‹å†™å…«å­—  
â€¢ è¯¢é—®ä»»ä½•å‘½ç†ç›¸å…³é—®é¢˜
â€¢ è¿›è¡Œæ·±åº¦å‘½ç†æŽ¢è®¨

æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ"""
        else:
            response = f"""æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼

å…³äºŽ"{message}"ï¼Œæˆ‘éœ€è¦äº†è§£æ›´å¤šå…·ä½“ä¿¡æ¯æ‰èƒ½ç»™å‡ºå‡†ç¡®çš„åˆ†æžã€‚æ‚¨èƒ½è¯¦ç»†è¯´æ˜Žä¸€ä¸‹å—ï¼Ÿ

å¦‚æžœæ‚¨æ˜¯æƒ³è¿›è¡Œå…«å­—åˆ†æžï¼Œè¯·æä¾›å‡ºç”Ÿæ—¥æœŸã€æ—¶é—´å’Œåœ°ç‚¹ã€‚å¦‚æžœæ˜¯å…¶ä»–å‘½ç†é—®é¢˜ï¼Œä¹Ÿè¯·å°½é‡è¯¦ç»†æè¿°ï¼Œè¿™æ ·æˆ‘æ‰èƒ½ç»™æ‚¨æœ€æœ‰ä»·å€¼çš„å»ºè®®ã€‚

æœŸå¾…ä¸Žæ‚¨æ·±å…¥äº¤æµï¼ ðŸ™"""
        
        # Update conversation history
        self.conversation_history.append({"user": message, "ai": response})
        if len(self.conversation_history) > 10:
            self.conversation_history.pop(0)
        
        return response